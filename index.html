<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ZTERA ‚Äì TeraBox Player & Downloader</title>

<meta name="theme-color" content="#3248f5">

<!-- HLS -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
body{margin:0;font-family:Inter,system-ui;background:#eef3ff}
.wrap{max-width:980px;margin:30px auto;padding:16px}
.hero{text-align:center}
h1{color:#3248f5;font-size:38px}
.card{background:#fff;padding:22px;border-radius:20px}

input{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid #ccc;
  font-size:16px
}

.btn{
  margin-top:16px;
  padding:14px;
  border-radius:16px;
  background:#4f46e5;
  color:#fff;
  font-size:18px;
  font-weight:700;
  border:0;
  width:100%;
  cursor:pointer
}

.loading{
  margin-top:14px;
  text-align:center;
  font-weight:700;
  color:#3248f5;
  display:none
}

.player{
  margin-top:22px;
  display:none
}

video{
  width:100%;
  max-height:70vh;
  background:#000;
  border-radius:16px
}

.actions{
  display:flex;
  gap:12px;
  margin-top:14px
}

.action-btn{
  flex:1;
  padding:14px;
  border-radius:14px;
  font-weight:700;
  text-align:center;
  text-decoration:none;
  cursor:pointer
}

.browser{background:#16a34a;color:#fff}
.server{background:#2563eb;color:#fff}

.error{
  margin-top:14px;
  color:#dc2626;
  font-weight:700;
  text-align:center;
  display:none
}
</style>
</head>

<body>

<div class="wrap">
<header class="hero">
<h1>ZTERA ‚Äì Inline Player</h1>
<p>Play & Download TeraBox Videos</p>
</header>

<section class="card">
<input id="tbxUrl" placeholder="Paste Terabox link here">
<button class="btn" onclick="start()">‚ñ∂ Play Video</button>

<div id="loading" class="loading">‚è≥ Fetching video‚Ä¶</div>
<div id="error" class="error"></div>

<div id="player" class="player">
  <video id="video" controls playsinline preload="auto"></video>

  <div class="actions">
    <button class="action-btn browser" onclick="browserPlay()">
      ‚ñ∂ Browser Play & Download
    </button>
    <button class="action-btn server" onclick="serverDownload()">
      ‚¨á Render Server Download
    </button>
  </div>
</div>
</section>
</div>

<script>
const API = "https://iteraplay.in/api/fetch?url=";
const RENDER = "https://ztera-downloader.onrender.com";

let mirrors={}, bestStream="", hls=null;

/* üîÅ FETCH WITH RETRY */
async function fetchWithRetry(url, retries=3){
  for(let i=0;i<retries;i++){
    try{
      const c=new AbortController();
      setTimeout(()=>c.abort(),10000);

      const r=await fetch(url,{cache:"no-store",signal:c.signal});
      if(!r.ok) throw 0;
      return await r.json();
    }catch(e){
      if(i===retries-1) throw e;
    }
  }
}

/* üöÄ START */
async function start(){
  const link=tbxUrl.value.trim();
  if(link.length<10) return showError("Invalid link");

  error.style.display="none";
  loading.style.display="block";
  player.style.display="none";

  try{
    const data=await fetchWithRetry(API+encodeURIComponent(link));
    if(data.status!=="success") throw 0;

    const f=data.list[0];
    mirrors=f.fast_stream_url||{};
    mirrors.base=f.stream_url;

    bestStream =
      mirrors["1080p"] ||
      mirrors["720p"] ||
      mirrors["360p"] ||
      mirrors.base;

    playInline(bestStream);

    loading.style.display="none";
    player.style.display="block";

  }catch{
    loading.style.display="none";
    showError("Server busy, try again");
  }
}

/* ‚ñ∂ INLINE PLAY */
function playInline(url){
  if(hls){hls.destroy();hls=null}

  if(url.includes(".m3u8")){
    if(video.canPlayType("application/vnd.apple.mpegurl")){
      video.src=url;
    }else if(Hls.isSupported()){
      hls=new Hls();
      hls.loadSource(url);
      hls.attachMedia(video);
    }
  }else{
    video.src=url;
  }
  video.play().catch(()=>{});
}

/* ‚ñ∂ BROWSER PLAY + DOWNLOAD */
function browserPlay(){
  window.open(bestStream,"_blank");
}

/* ‚¨á SERVER DOWNLOAD */
async function serverDownload(){
  try{
    const t=await fetch(
      RENDER+"/token?url="+encodeURIComponent(bestStream)
    ).then(r=>r.json());

    window.location.href =
      RENDER+"/download?token="+t.token+"&name=ztera_video.mp4";
  }catch{
    alert("Download server busy");
  }
}

function showError(msg){
  error.textContent=msg;
  error.style.display="block";
}
</script>

</body>
</html>
